{% extends "core/base.html" %}

{% block content %}
<style>
    /* Basic styling for the chat window */
    #chat-window {
        height: 400px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        overflow-y: auto;
        margin-bottom: 1rem;
        background-color: #f9f9f9;
    }
    .message {
        padding: 0.5rem 1rem;
        border-radius: 15px;
        margin-bottom: 0.5rem;
        max-width: 70%;
    }
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    .bot-message {
        background-color: #e9ecef;
        color: #333;
        margin-right: auto;
    }
</style>

<div class="card">
    <h2>AI Assistant</h2>
    <p>Ask me a question about your account. For example: "How do I check my balance?"</p>
    <div id="chat-window">
        </div>
    <form id="chat-form" style="display: flex;">
        <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." autocomplete="off" style="flex-grow: 1; margin-right: 1rem;">
        <button type="submit" class="btn">Send</button>
    </form>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    // This is needed to send secure requests to Django
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    chatForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const userMessage = chatInput.value.trim();
        if (userMessage) {
            // 1. Display the user's message
            addMessage(userMessage, 'user-message');
            // 2. Send the message to the bot and get a response
            getBotResponse(userMessage);
            chatInput.value = '';
        }
    });

    function addMessage(message, className) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', className);
        messageElement.textContent = message;
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to bottom
    }

    async function getBotResponse(userMessage) {
        try {
            const response = await fetch("{% url 'chatbot_api' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ message: userMessage })
            });
            const data = await response.json();
            // 3. Display the bot's response
            addMessage(data.response, 'bot-message');
        } catch (error) {
            console.error("Error:", error);
            addMessage("Sorry, something went wrong. Please try again.", 'bot-message');
        }
    }
</script>
{% endblock %}
{% extends "core/base.html" %}

{% block content %}
<style>
    /* ... (All your CSS styles from before remain the same) ... */
    #chat-window { height: 400px; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; overflow-y: auto; margin-bottom: 1rem; background-color: #f9f9f9; display: flex; flex-direction: column; }
    .message { padding: 0.5rem 1rem; border-radius: 15px; margin-bottom: 0.5rem; max-width: 70%; white-space: pre-wrap; line-height: 1.4; }
    .user-message { background-color: #0d6efd; color: white; margin-left: auto; text-align: right; }
    .bot-message { background-color: #e9ecef; color: #333; margin-right: auto; }
    #suggestion-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
    .chip { padding: 0.5rem 1rem; border-radius: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; }
    .chip:hover { background-color: #e9ecef; border-color: #adb5bd; }
    .typing-indicator { display: none; padding: 0.5rem 1rem; border-radius: 15px; margin-bottom: 0.5rem; max-width: 70%; background-color: #e9ecef; color: #333; margin-right: auto; }
    .typing-indicator span { height: 8px; width: 8px; background-color: #6c757d; border-radius: 50%; display: inline-block; animation: bounce 1.3s infinite; }
    .typing-indicator span:nth-of-type(2) { animation-delay: 0.15s; }
    .typing-indicator span:nth-of-type(3) { animation-delay: 0.3s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    
    /* --- NEW: Styling for the confirm button --- */
    .confirm-button {
        background-color: #198754; /* Bootstrap success green */
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 0.5rem;
    }
    .confirm-button:hover {
        background-color: #157347;
    }
</style>

<div class="card shadow-sm">
    <div class="card-body">
        <h2 class="card-title h4 mb-3">AI Assistant</h2>
        <p class="card-subtitle mb-2 text-muted">Try asking: "Send 100 from checking to savings"</p>
        
        <div id="chat-window">
            <div id="typing-indicator" class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>

        <div id="suggestion-chips">
            <div class="chip" data-question="What's my balance?">What's my balance?</div>
            <div class="chip" data-question="Show my recent transactions">Recent transactions</div>
            <div class="chip" data-question="transfer 50 from checking to savings">Transfer 50 (Checking to Savings)</div>
        </div>

        <form id="chat-form" style="display: flex;">
            <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." autocomplete="off" style="flex-grow: 1; margin-right: 1rem;">
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
    </div>
</div>

<script>
    // --- Get all our HTML elements ---
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const suggestionChipsContainer = document.getElementById('suggestion-chips');
    const typingIndicator = document.getElementById('typing-indicator');
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    // --- Event Listeners ---
    chatForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const userMessage = chatInput.value.trim();
        if (userMessage) {
            handleUserMessage(userMessage);
            chatInput.value = '';
        }
    });

    suggestionChipsContainer.addEventListener('click', function(event) {
        if (event.target.classList.contains('chip')) {
            const question = event.target.getAttribute('data-question');
            handleUserMessage(question);
        }
    });

    function handleUserMessage(message) {
        addMessage(message, 'user-message');
        suggestionChipsContainer.style.display = 'none';
        showTypingIndicator(true);
        getBotResponse(message);
    }

    function showTypingIndicator(show) {
        typingIndicator.style.display = show ? 'block' : 'none';
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function addMessage(message, className) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', className);
        messageElement.textContent = message;
        chatWindow.insertBefore(messageElement, typingIndicator);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // --- UPDATED: getBotResponse function ---
    async function getBotResponse(userMessage) {
        try {
            const response = await fetch("{% url 'chatbot_api' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ message: userMessage })
            });
            const data = await response.json();

            // Hide typing indicator
            showTypingIndicator(false);
            
            // --- NEW LOGIC: Check response type ---
            if (data.type === 'confirmation') {
                // This is a transaction proposal, not just a message
                addConfirmationMessage(data.message, data.details);
            } else {
                // This is a standard text response
                addMessage(data.response, 'bot-message');
            }

        } catch (error) {
            console.error("Error:", error);
            showTypingIndicator(false);
            addMessage("Sorry, something went wrong. Please try again.", 'bot-message');
        }
    }

    // --- NEW: Function to add the confirmation button ---
    function addConfirmationMessage(message, details) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', 'bot-message');
        messageElement.textContent = message;
        
        // Create the confirm button
        const confirmButton = document.createElement('button');
        confirmButton.classList.add('confirm-button');
        confirmButton.textContent = 'Confirm Transfer';
        
        // Store the transaction details on the button itself
        confirmButton.dataset.amount = details.amount;
        confirmButton.dataset.fromType = details.from_type;
        confirmButton.dataset.toType = details.to_type;

        // Add click listener for the new button
        confirmButton.onclick = handleConfirmClick;
        
        messageElement.appendChild(document.createElement('br'));
        messageElement.appendChild(confirmButton);
        chatWindow.insertBefore(messageElement, typingIndicator);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // --- NEW: Function to handle the confirm button click ---
    async function handleConfirmClick(event) {
        const button = event.target;
        const { amount, fromType, toType } = button.dataset;

        // Disable button to prevent double-click
        button.disabled = true;
        button.textContent = 'Processing...';

        try {
            const response = await fetch("{% url 'chatbot_execute_transfer' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({
                    amount: amount,
                    from_type: fromType,
                    to_type: toType
                })
            });
            const data = await response.json();

            if (data.status === 'success') {
                addMessage(data.message, 'bot-message');
            } else {
                addMessage(`Error: ${data.message}`, 'bot-message');
            }
        } catch (error) {
            console.error("Error:", error);
            addMessage("Sorry, the transfer failed. Please try again.", 'bot-message');
        } finally {
            // Remove the button after the action is done
            button.parentElement.removeChild(button);
        }
    }
</script>
{% endblock %}